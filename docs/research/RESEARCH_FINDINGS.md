# Package Manager Lock File Formats Research

## Executive Summary

This document provides comprehensive research on major npm-compatible package manager lock file formats for implementing vulnerability scanning in the Muaddib project.

---

## 1. yarn.lock (Yarn v1 Classic)

### File Format
- **Type**: Plain text, custom format (not JSON/YAML)
- **File version**: Indicated by `# yarn lockfile v1` header
- **Market Share**: High (legacy, but still widely used)

### Structure

```yaml
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1

package-name@^1.0.0:
  version "1.0.3"
  resolved "https://registry.npmjs.org/package-name/-/package-name-1.0.3.tgz#hash"
  integrity sha512-...
  dependencies:
    another-package "^2.0.0"

package-name@^1.0.0, package-name@^1.5.0:
  version "1.5.2"
  resolved "https://registry.npmjs.org/package-name/-/package-name-1.5.2.tgz#hash"
```

### Key Characteristics
- **Package identifier**: `package-name@version-range` (can have multiple ranges pointing to same entry)
- **Version extraction**: `version "x.x.x"` field
- **Dependencies**: Nested under `dependencies:` field (optional)
- **Transitive deps**: YES - all dependencies are flattened
- **Scoped packages**: Supported (`@scope/package@^1.0.0`)

### Parsing Strategy
- **Complexity**: Medium
- **Approach**: Custom parser (not standard format)
- **Line-by-line parsing**:
  1. Look for lines matching `package@range:` (no leading whitespace)
  2. Parse indented fields (version, resolved, integrity, dependencies)
  3. Handle multi-range entries (comma-separated)

### Go Libraries
- `github.com/sojebsikder/go-yarn-lock-parser` - Available but minimal
- Custom parser recommended (format is simple enough)

---

## 2. yarn.lock (Yarn v2+ Berry)

### File Format
- **Type**: YAML-like text format (but not standard YAML)
- **File version**: `__metadata:\n  version: 8` (or other numbers)
- **Market Share**: Medium-Low (Modern Yarn users)

### Structure

```yaml
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 8
  cacheKey: 10

"package-name@npm:^1.0.0":
  version: 1.2.6
  resolution: "package-name@npm:1.2.6"
  checksum: 10/a1b2c3d4...
  languageName: node
  linkType: hard

"@scope/package@npm:^2.0.0":
  version: 2.1.0
  resolution: "@scope/package@npm:2.1.0"
  dependencies:
    dep-package: "npm:^3.0.0"
  checksum: 10/f4e5d6...
  languageName: node
  linkType: hard
```

### Key Characteristics
- **Package identifier**: `"package-name@npm:^range"` (quoted, with protocol)
- **Version extraction**: `version: x.x.x` field
- **Resolution**: Contains the actual installed version
- **Transitive deps**: YES
- **Scoped packages**: Supported

### Detection
- Look for `__metadata:` section at the top
- Version number 6+ indicates Berry (v2+)
- Quoted package identifiers with `@npm:` protocol

### Parsing Strategy
- **Complexity**: Medium-Hard
- **Approach**: YAML parser with custom logic
- **Steps**:
  1. Use YAML parser to read structure
  2. Iterate over keys (excluding `__metadata`)
  3. Extract package name from quoted identifier
  4. Read `version` or `resolution` field

### Go Libraries
- `gopkg.in/yaml.v3` - Standard YAML parsing
- Custom logic needed for package name extraction

---

## 3. pnpm-lock.yaml

### File Format
- **Type**: Standard YAML
- **File version**: `lockfileVersion: '9.0'` (or 5.4, 6.0, etc.)
- **Market Share**: Growing (popular in monorepos)

### Structure

```yaml
lockfileVersion: '9.0'

settings:
  autoInstallPeers: true
  excludeLinksFromLockfile: false

importers:
  .:
    dependencies:
      express:
        specifier: ^4.18.2
        version: 4.21.2
      lodash:
        specifier: ^4.17.21
        version: 4.17.21

packages:
  accepts@1.3.8:
    resolution: {integrity: sha512-...}
    engines: {node: '>= 0.6'}

  express@4.21.2:
    resolution: {integrity: sha512-...}
    engines: {node: '>= 0.10.0'}
    dependencies:
      accepts: 1.3.8
      body-parser: 1.20.3
```

### Key Characteristics
- **Two sections**:
  - `importers`: Direct dependencies with specifiers
  - `packages`: All resolved packages (transitive)
- **Package identifier**: `package-name@version` in packages section
- **Version extraction**: From identifier OR from `version` field in importers
- **Transitive deps**: YES - in `packages` section
- **Scoped packages**: Supported

### Parsing Strategy
- **Complexity**: Easy
- **Approach**: Standard YAML parser
- **Steps**:
  1. Parse YAML
  2. Iterate `importers.*.dependencies` for direct deps
  3. Iterate `packages` keys for all deps (including transitive)
  4. Split key on `@` to get name and version

### Go Libraries
- `gopkg.in/yaml.v3` - Perfect fit, standard YAML
- No custom parsing needed

---

## 4. npm-shrinkwrap.json

### File Format
- **Type**: JSON (identical to package-lock.json)
- **Market Share**: Low (deprecated in favor of package-lock.json)
- **Still Relevant**: Rarely used, mainly for publishing

### Key Characteristics
- **Identical format** to `package-lock.json`
- **Takes precedence** over package-lock.json if both exist
- **Use case**: Published packages (discouraged for libraries)

### Parsing Strategy
- **Complexity**: Easy (same as package-lock.json)
- **Approach**: Use existing package-lock.json parser
- **Priority**: LOW (already handled by existing code)

### Recommendation
**Support via existing parser** - Muaddib already parses package-lock.json, which is identical format.

---

## 5. bun.lockb (Binary) & bun.lock (Text)

### File Format (Binary - Legacy)
- **Type**: Binary format (custom)
- **File name**: `bun.lockb`
- **Market Share**: Low-Medium (Bun users)
- **Status**: DEPRECATED in Bun v1.2+

### File Format (Text - Current)
- **Type**: Text format (custom, similar to Yarn Berry)
- **File name**: `bun.lock`
- **Market Share**: Low-Medium (Bun users)
- **Status**: Current default since Bun v1.2

### Structure (Text Format)

```
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.

__metadata:
  version: 2

"package-name@npm:^1.0.0":
  version: 1.2.3
  resolved: "https://registry.npmjs.org/package-name/-/package-name-1.2.3.tgz"
  integrity: sha512-...
  dependencies:
    dep: ^2.0.0
```

### Key Characteristics (Text)
- **Similar to Yarn Berry** format
- **Package identifier**: Quoted with npm: protocol
- **Version extraction**: `version:` field
- **Transitive deps**: YES
- **Migration**: Bun auto-migrates from yarn.lock, package-lock.json, pnpm-lock.yaml

### Parsing Strategy (Binary)
- **Complexity**: VERY HARD
- **Feasibility**: Low (proprietary binary format)
- **Recommendation**: SKIP binary format

### Parsing Strategy (Text)
- **Complexity**: Medium (similar to Yarn Berry)
- **Approach**: Similar to Yarn v2+ parser
- **Go Libraries**: YAML parser + custom logic

### Recommendation
- **Text format (bun.lock)**: Support with medium priority
- **Binary format (bun.lockb)**: SKIP (deprecated, proprietary)

---

## Priority Ranking

### Tier 1: High Priority
1. **pnpm-lock.yaml** ⭐⭐⭐⭐⭐
   - **Reason**: Easy to parse (standard YAML), growing popularity, great for monorepos
   - **Effort**: LOW
   - **Value**: HIGH
   - **Parsing**: Use `gopkg.in/yaml.v3`

2. **yarn.lock (v1)** ⭐⭐⭐⭐
   - **Reason**: Still very widely used, medium complexity
   - **Effort**: MEDIUM
   - **Value**: HIGH
   - **Parsing**: Custom line-by-line parser

### Tier 2: Medium Priority
3. **yarn.lock (v2+ Berry)** ⭐⭐⭐
   - **Reason**: Growing adoption, modern Yarn users
   - **Effort**: MEDIUM-HIGH
   - **Value**: MEDIUM
   - **Parsing**: YAML + custom logic for package identifiers

4. **bun.lock (text)** ⭐⭐
   - **Reason**: Bun gaining traction, text format is parseable
   - **Effort**: MEDIUM
   - **Value**: MEDIUM-LOW
   - **Parsing**: Similar to Yarn Berry

### Tier 3: Low Priority
5. **npm-shrinkwrap.json** ⭐
   - **Reason**: Already supported (same as package-lock.json)
   - **Effort**: NONE (use existing parser)
   - **Value**: LOW (rarely used)

6. **bun.lockb (binary)** ❌
   - **Reason**: Deprecated, proprietary format
   - **Effort**: VERY HIGH
   - **Value**: NONE
   - **Recommendation**: DO NOT SUPPORT

---

## Implementation Recommendations

### Phase 1: Easy Wins
1. Add **pnpm-lock.yaml** support
   - Import `gopkg.in/yaml.v3`
   - Parse `packages` section keys
   - Split on `@` to extract name/version
   - Reuse existing matcher logic

2. Ensure **npm-shrinkwrap.json** works
   - Test with existing package-lock.json parser
   - Add to file detection in contents.go

### Phase 2: High Value
3. Add **yarn.lock (v1)** support
   - Custom parser for custom format
   - Line-by-line state machine
   - Handle multi-range entries
   - Test with real yarn.lock files

### Phase 3: Modern Package Managers
4. Add **yarn.lock (v2+ Berry)** support
   - YAML parser
   - Extract package names from quoted identifiers
   - Handle `@npm:` protocol prefix

5. Add **bun.lock (text)** support
   - Similar approach to Yarn Berry
   - Lower priority due to smaller user base

### Phase 4: Edge Cases
6. Handle **bun.lockb detection**
   - Detect binary format
   - Log warning: "Binary bun.lockb not supported, please upgrade to Bun v1.2+ for text format"

---

## Example Parsing Code Snippets

### pnpm-lock.yaml Parser (Go)

```go
import "gopkg.in/yaml.v3"

type PnpmLock struct {
    LockfileVersion string `yaml:"lockfileVersion"`
    Packages        map[string]PnpmPackage `yaml:"packages"`
}

type PnpmPackage struct {
    Resolution   map[string]string `yaml:"resolution"`
    Dependencies map[string]string `yaml:"dependencies"`
}

func ParsePnpmLock(data []byte) ([]Package, error) {
    var lock PnpmLock
    if err := yaml.Unmarshal(data, &lock); err != nil {
        return nil, err
    }

    var packages []Package
    for nameVersion := range lock.Packages {
        parts := strings.Split(nameVersion, "@")
        var name, version string

        if strings.HasPrefix(nameVersion, "@") {
            // Scoped package: @scope/name@version
            if len(parts) >= 3 {
                name = "@" + parts[1]
                version = parts[2]
            }
        } else {
            // Regular: name@version
            if len(parts) >= 2 {
                name = parts[0]
                version = parts[1]
            }
        }

        if name != "" && version != "" {
            packages = append(packages, Package{Name: name, Version: version})
        }
    }
    return packages, nil
}
```

### yarn.lock v1 Parser (Go)

```go
func ParseYarnLockV1(data string) ([]Package, error) {
    var packages []Package
    lines := strings.Split(data, "\n")

    var currentPackage string
    var currentVersion string

    for _, line := range lines {
        // Package declaration (no leading whitespace, ends with :)
        if !strings.HasPrefix(line, " ") && strings.HasSuffix(line, ":") {
            // Extract package name (handle multi-range)
            pkgLine := strings.TrimSuffix(line, ":")
            // Take first range only
            if idx := strings.Index(pkgLine, ","); idx > 0 {
                pkgLine = pkgLine[:idx]
            }

            // Extract name from "package@range"
            if idx := strings.LastIndex(pkgLine, "@"); idx > 0 {
                currentPackage = pkgLine[:idx]
                currentVersion = "" // Reset
            }
        } else if strings.HasPrefix(line, "  version ") {
            // Extract version
            currentVersion = strings.Trim(strings.TrimPrefix(line, "  version "), `"`)

            if currentPackage != "" && currentVersion != "" {
                packages = append(packages, Package{
                    Name: currentPackage,
                    Version: currentVersion,
                })
            }
        }
    }

    return packages, nil
}
```

---

## Testing Strategy

### Test Files to Create
1. `testdata/pnpm-lock.yaml` - Real pnpm lockfile
2. `testdata/yarn-v1.lock` - Yarn Classic lockfile
3. `testdata/yarn-berry.lock` - Yarn v2+ lockfile
4. `testdata/bun.lock` - Bun text lockfile
5. `testdata/npm-shrinkwrap.json` - Shrinkwrap file

### Test Cases
- Parse each format successfully
- Extract package names and versions
- Handle scoped packages (@scope/name)
- Handle transitive dependencies
- Detect correct format version
- Handle malformed/truncated files gracefully

---

## Market Share Estimates (2024-2025)

Based on npm trends and community adoption:

1. **npm (package-lock.json)**: ~70% ✅ Already supported
2. **yarn v1 (yarn.lock)**: ~15-20%
3. **pnpm (pnpm-lock.yaml)**: ~5-10% (growing)
4. **yarn v2+ (yarn.lock)**: ~3-5%
5. **bun (bun.lock)**: ~1-2% (growing fast)

### ROI Analysis
- **pnpm**: Low effort, high growth = HIGH ROI
- **yarn v1**: Medium effort, large user base = HIGH ROI
- **yarn v2+**: Medium effort, smaller user base = MEDIUM ROI
- **bun text**: Medium effort, small but growing = MEDIUM ROI
- **bun binary**: Very high effort, deprecated = NEGATIVE ROI

---

## Next Steps

1. ✅ Research complete
2. Start with pnpm-lock.yaml (easiest, growing adoption)
3. Add yarn.lock v1 support (large user base)
4. Consider yarn v2+ and bun.lock based on user demand
5. Document supported formats in README
6. Add format detection to github/contents.go
